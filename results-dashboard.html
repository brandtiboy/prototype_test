<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrototypeTester â€” Results</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #f8f9fa;
      --surface:  #ffffff;
      --border:   #e5e7eb;
      --text:     #111827;
      --muted:    #6b7280;
      --accent:   #6366f1;
      --green:    #10b981;
      --amber:    #f59e0b;
      --red:      #ef4444;
      --radius:   10px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header .logo {
      font-weight: 700;
      font-size: 15px;
      letter-spacing: -0.3px;
    }
    header .logo span { color: var(--accent); }
    header .sep { color: var(--border); font-size: 18px; }
    header .subtitle { color: var(--muted); font-size: 13px; }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
    .btn-outline {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 12px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text);
    }
    .btn-outline:hover { background: var(--bg); }

    /* â”€â”€ Connect screen â”€â”€ */
    #connect-screen {
      max-width: 480px;
      margin: 80px auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
    }
    #connect-screen h1 { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
    #connect-screen p  { color: var(--muted); margin-bottom: 24px; font-size: 13px; }
    .field { margin-bottom: 14px; }
    .field label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .field input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 9px 12px;
      font-size: 13px;
      outline: none;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }
    .field input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.12); }
    .btn-primary {
      width: 100%;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .btn-primary:hover { background: #4f46e5; }
    .connect-error { color: var(--red); font-size: 12px; margin-top: 10px; display: none; }

    /* â”€â”€ Main layout â”€â”€ */
    #app { display: none; }
    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 56px); }

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 16px 0;
      position: sticky;
      top: 56px;
      height: calc(100vh - 56px);
      overflow-y: auto;
    }
    .sidebar-section-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 8px 16px 4px;
    }
    .project-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 0;
      transition: background 0.1s;
      gap: 8px;
    }
    .project-item:hover { background: var(--bg); }
    .project-item.active { background: rgba(99,102,241,0.08); }
    .project-item.active .project-name { color: var(--accent); font-weight: 600; }
    .project-name { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .project-count {
      font-size: 11px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1px 7px;
      color: var(--muted);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .project-item.active .project-count {
      background: rgba(99,102,241,0.12);
      border-color: rgba(99,102,241,0.2);
      color: var(--accent);
    }

    /* â”€â”€ Main content â”€â”€ */
    .main { padding: 24px 28px; overflow: auto; }

    /* â”€â”€ Summary cards â”€â”€ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
    }
    .stat-card .stat-label { font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; margin-top: 4px; }
    .stat-card .stat-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* â”€â”€ Section â”€â”€ */
    .section { margin-bottom: 28px; }
    .section-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; }

    /* â”€â”€ Task summary grid â”€â”€ */
    .task-grid { display: flex; flex-direction: column; gap: 10px; }
    .task-row {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      display: grid;
      grid-template-columns: 1fr 80px 80px 80px;
      align-items: center;
      gap: 12px;
    }
    .task-name { font-weight: 600; font-size: 13px; }
    .task-type { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .task-metric { text-align: center; }
    .task-metric .m-val { font-size: 18px; font-weight: 700; }
    .task-metric .m-lbl { font-size: 11px; color: var(--muted); }
    .green { color: var(--green); }
    .amber { color: var(--amber); }
    .red   { color: var(--red); }

    /* â”€â”€ Progress bar â”€â”€ */
    .prog-bar-wrap { background: var(--bg); border-radius: 4px; height: 6px; margin-top: 6px; }
    .prog-bar { height: 6px; border-radius: 4px; background: var(--green); }

    /* â”€â”€ Sessions table â”€â”€ */
    .sessions-table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 10px 14px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }
    tbody tr { cursor: pointer; transition: background 0.1s; }
    tbody tr:hover { background: #f9fafb; }
    tbody tr + tr td { border-top: 1px solid var(--border); }
    td { padding: 10px 14px; font-size: 13px; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
    }
    .badge-green { background: #d1fae5; color: #065f46; }
    .badge-amber { background: #fef3c7; color: #92400e; }
    .badge-red   { background: #fee2e2; color: #991b1b; }
    .stars { color: #fbbf24; letter-spacing: -1px; }

    /* â”€â”€ Session detail â”€â”€ */
    .session-detail-header {
      display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;
    }
    .back-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
      color: var(--muted);
      flex-shrink: 0;
    }
    .back-btn:hover { background: var(--bg); color: var(--text); }
    .session-meta h2 { font-size: 17px; font-weight: 700; }
    .session-meta p  { color: var(--muted); font-size: 13px; }

    .task-detail-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 12px;
      overflow: hidden;
    }
    .task-detail-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .task-detail-body { padding: 14px 16px; }
    .task-detail-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 8px; }
    .task-detail-meta { font-size: 12px; color: var(--muted); }
    .task-detail-meta strong { color: var(--text); }
    .comment-box {
      background: var(--bg);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      font-style: italic;
      margin-top: 8px;
      border-left: 3px solid var(--border);
    }
    .click-list { margin-top: 10px; }
    .click-list summary { font-size: 12px; color: var(--muted); cursor: pointer; }
    .click-list summary:hover { color: var(--text); }
    .click-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .click-chip {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 11px;
      color: var(--muted);
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    /* â”€â”€ Loader â”€â”€ */
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 60px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--muted);
    }
    .empty-state .icon { font-size: 36px; margin-bottom: 12px; }
    .empty-state p { max-width: 300px; margin: 0 auto; font-size: 13px; }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 700px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; }
      .task-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- â•â•â• Connect screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="connect-screen">
  <h1>PrototypeTester Results</h1>
  <p>Connect to your Supabase project to view test sessions and task results.</p>
  <div class="field">
    <label>Supabase Project URL</label>
    <input id="sb-url" type="url" placeholder="https://xxxx.supabase.co" autocomplete="off">
  </div>
  <div class="field">
    <label>Anon / Public Key</label>
    <input id="sb-key" type="text" placeholder="eyJhbGciOiJIUzI1NiIs..." autocomplete="off">
  </div>
  <button class="btn-primary" id="connect-btn">Connect â†’</button>
  <p class="connect-error" id="connect-error"></p>
</div>

<!-- â•â•â• App â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <header>
    <div class="logo">Prototype<span>Tester</span></div>
    <span class="sep">|</span>
    <span class="subtitle">Results</span>
    <div class="header-right">
      <span id="hdr-project" style="font-size:13px;color:var(--muted)"></span>
      <button class="btn-outline" id="disconnect-btn">Disconnect</button>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section-label">Tests</div>
      <div id="project-list"></div>
    </aside>

    <!-- Main -->
    <main class="main" id="main-content">
      <div class="empty-state">
        <div class="icon">â†</div>
        <p>Select a test from the sidebar to view results.</p>
      </div>
    </main>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _url = '', _key = '', _sessions = [], _activeProject = null, _activeSession = null;

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $id(id) { return document.getElementById(id); }

function starsHtml(n) {
  if (!n) return '<span style="color:var(--muted)">â€”</span>';
  return '<span class="stars">' + 'â˜…'.repeat(n) + '<span style="opacity:0.25">' + 'â˜…'.repeat(5 - n) + '</span></span>';
}

function completionColor(pct) {
  if (pct >= 80) return 'green';
  if (pct >= 50) return 'amber';
  return 'red';
}

function formatDate(iso) {
  return new Date(iso).toLocaleDateString('en-GB', {
    day: 'numeric', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit',
  });
}

function avg(arr) {
  const nums = arr.filter(n => n != null && !isNaN(n));
  return nums.length ? nums.reduce((a, b) => a + b, 0) / nums.length : null;
}

// â”€â”€â”€ Supabase fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbFetch(path) {
  const res = await fetch(`${_url}${path}`, {
    headers: { 'apikey': _key, 'Authorization': `Bearer ${_key}` },
  });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

// â”€â”€â”€ Connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$id('connect-btn').onclick = async () => {
  const url = $id('sb-url').value.trim().replace(/\/$/, '');
  const key = $id('sb-key').value.trim();
  const errEl = $id('connect-error');
  errEl.style.display = 'none';

  if (!url || !key) { errEl.textContent = 'Please fill in both fields.'; errEl.style.display = 'block'; return; }

  $id('connect-btn').textContent = 'Connectingâ€¦';
  try {
    _url = url; _key = key;
    _sessions = await sbFetch('/rest/v1/test_sessions?select=*&order=submitted_at.desc');
    $id('connect-screen').style.display = 'none';
    $id('app').style.display = 'block';
    renderSidebar();
  } catch (e) {
    errEl.textContent = 'Could not connect: ' + e.message + '. Check your URL and key, and make sure Row Level Security allows SELECT.';
    errEl.style.display = 'block';
    $id('connect-btn').textContent = 'Connect â†’';
    _url = ''; _key = '';
  }
};

$id('disconnect-btn').onclick = () => {
  _url = ''; _key = ''; _sessions = []; _activeProject = null; _activeSession = null;
  $id('app').style.display = 'none';
  $id('connect-screen').style.display = 'block';
  $id('connect-btn').textContent = 'Connect â†’';
};

// Allow Enter key on inputs
[$id('sb-url'), $id('sb-key')].forEach(el =>
  el.addEventListener('keydown', e => { if (e.key === 'Enter') $id('connect-btn').click(); })
);

// â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSidebar() {
  const projects = [...new Set(_sessions.map(s => s.project_name))];
  const list = $id('project-list');
  list.innerHTML = '';

  if (!projects.length) {
    list.innerHTML = '<div style="padding:12px 16px;font-size:13px;color:var(--muted)">No sessions yet.</div>';
    return;
  }

  projects.forEach(name => {
    const count = _sessions.filter(s => s.project_name === name).length;
    const el = document.createElement('div');
    el.className = 'project-item' + (name === _activeProject ? ' active' : '');
    el.innerHTML = `<span class="project-name" title="${name}">${name}</span><span class="project-count">${count}</span>`;
    el.onclick = () => selectProject(name);
    list.appendChild(el);
  });
}

// â”€â”€â”€ Project view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectProject(name) {
  _activeProject = name;
  _activeSession = null;
  renderSidebar();

  const sessions = _sessions.filter(s => s.project_name === name);

  // â”€â”€ Summary stats
  const totalSessions = sessions.length;
  const avgCompletion = avg(sessions.map(s => s.total_tasks ? (s.completed_tasks / s.total_tasks) * 100 : null));
  const avgRating = avg(sessions.map(s => s.overall_rating));

  // â”€â”€ Per-task aggregation
  const taskMap = {};
  sessions.forEach(s => {
    const tasks = Array.isArray(s.tasks) ? s.tasks : [];
    tasks.forEach(t => {
      if (!taskMap[t.taskId]) taskMap[t.taskId] = { title: t.taskTitle, type: t.taskType || 'standard', completions: [], easeRatings: [], durations: [] };
      taskMap[t.taskId].completions.push(t.completed ? 1 : 0);
      if (t.easeRating) taskMap[t.taskId].easeRatings.push(t.easeRating);
      if (t.durationFmt) taskMap[t.taskId].durations.push(t.durationFmt);
    });
  });

  const main = $id('main-content');
  main.innerHTML = '';

  // Header
  const hdr = document.createElement('div');
  hdr.innerHTML = `<h2 style="font-size:18px;font-weight:700;margin-bottom:4px">${name}</h2>
    <p style="color:var(--muted);font-size:13px;margin-bottom:20px">${totalSessions} session${totalSessions !== 1 ? 's' : ''}</p>`;
  main.appendChild(hdr);

  // Stats row
  const statsRow = document.createElement('div');
  statsRow.className = 'stats-row';
  const pct = avgCompletion != null ? Math.round(avgCompletion) : null;
  statsRow.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Sessions</div>
      <div class="stat-value">${totalSessions}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Avg completion</div>
      <div class="stat-value ${pct != null ? completionColor(pct) : ''}">${pct != null ? pct + '%' : 'â€”'}</div>
      ${pct != null ? `<div class="prog-bar-wrap"><div class="prog-bar" style="width:${pct}%;background:var(--${completionColor(pct)})"></div></div>` : ''}
    </div>
    <div class="stat-card">
      <div class="stat-label">Avg overall rating</div>
      <div class="stat-value">${avgRating != null ? avgRating.toFixed(1) + ' / 5' : 'â€”'}</div>
      <div class="stat-sub">${starsHtml(avgRating ? Math.round(avgRating) : null)}</div>
    </div>
  `;
  main.appendChild(statsRow);

  // Per-task breakdown
  if (Object.keys(taskMap).length) {
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.innerHTML = '<div class="section-title">Tasks</div>';
    const grid = document.createElement('div');
    grid.className = 'task-grid';

    Object.entries(taskMap).forEach(([id, t]) => {
      const compPct = Math.round(avg(t.completions) * 100);
      const easeAvg = avg(t.easeRatings);
      const row = document.createElement('div');
      row.className = 'task-row';
      row.innerHTML = `
        <div>
          <div class="task-name">${t.title}</div>
          <div class="task-type">${t.type === 'recall' ? 'ğŸ” Recall task' : 'ğŸ¯ Goal task'} &nbsp;Â·&nbsp; ${t.completions.length} responses</div>
          <div class="prog-bar-wrap" style="margin-top:8px;width:100%">
            <div class="prog-bar" style="width:${compPct}%;background:var(--${completionColor(compPct)})"></div>
          </div>
        </div>
        <div class="task-metric">
          <div class="m-val ${completionColor(compPct)}">${compPct}%</div>
          <div class="m-lbl">Completed</div>
        </div>
        <div class="task-metric">
          <div class="m-val">${easeAvg != null ? easeAvg.toFixed(1) : 'â€”'}</div>
          <div class="m-lbl">Avg ease /5</div>
        </div>
        <div class="task-metric">
          <div class="m-val" style="font-size:13px">${t.durations.length ? t.durations[0] : 'â€”'}</div>
          <div class="m-lbl">Median time</div>
        </div>
      `;
      grid.appendChild(row);
    });

    sec.appendChild(grid);
    main.appendChild(sec);
  }

  // Sessions table
  const sec2 = document.createElement('div');
  sec2.className = 'section';
  sec2.innerHTML = '<div class="section-title">All sessions</div>';

  const wrap = document.createElement('div');
  wrap.className = 'sessions-table-wrap';
  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Tester</th>
          <th>Date</th>
          <th>Duration</th>
          <th>Completion</th>
          <th>Rating</th>
        </tr>
      </thead>
      <tbody id="sessions-tbody"></tbody>
    </table>
  `;
  sec2.appendChild(wrap);
  main.appendChild(sec2);

  const tbody = wrap.querySelector('#sessions-tbody');
  sessions.forEach(s => {
    const pct2 = s.total_tasks ? Math.round((s.completed_tasks / s.total_tasks) * 100) : null;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${s.tester_name || 'â€”'}</strong><br><span style="color:var(--muted);font-size:11px">${s.tester_email || ''}</span></td>
      <td style="color:var(--muted)">${formatDate(s.submitted_at)}</td>
      <td>${s.session_duration_fmt || 'â€”'}</td>
      <td>${pct2 != null ? `<span class="badge badge-${completionColor(pct2)}">${pct2}%</span>` : 'â€”'}</td>
      <td>${starsHtml(s.overall_rating)}</td>
    `;
    tr.onclick = () => renderSession(s, name);
    tbody.appendChild(tr);
  });
}

// â”€â”€â”€ Session detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSession(s, projectName) {
  _activeSession = s;
  const main = $id('main-content');
  main.innerHTML = '';

  // Back button + header
  const hdr = document.createElement('div');
  hdr.className = 'session-detail-header';
  hdr.innerHTML = `
    <button class="back-btn" id="back-btn">â† Back</button>
    <div class="session-meta">
      <h2>${s.tester_name || 'Anonymous tester'}</h2>
      <p>${s.tester_email || ''} &nbsp;Â·&nbsp; ${formatDate(s.submitted_at)} &nbsp;Â·&nbsp; ${s.session_duration_fmt || 'â€”'}</p>
    </div>
  `;
  main.appendChild(hdr);
  $id('back-btn').onclick = () => selectProject(projectName);

  // Overall stats
  const statsRow = document.createElement('div');
  statsRow.className = 'stats-row';
  statsRow.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Tasks completed</div>
      <div class="stat-value">${s.completed_tasks} / ${s.total_tasks}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Overall rating</div>
      <div class="stat-value">${s.overall_rating != null ? s.overall_rating + ' / 5' : 'â€”'}</div>
      <div class="stat-sub">${starsHtml(s.overall_rating)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Session ID</div>
      <div class="stat-value" style="font-size:14px;font-family:monospace">${s.session_id}</div>
    </div>
  `;
  main.appendChild(statsRow);

  // Overall comment
  if (s.overall_comment) {
    const c = document.createElement('div');
    c.className = 'comment-box';
    c.style.marginBottom = '20px';
    c.textContent = '"' + s.overall_comment + '"';
    main.appendChild(c);
  }

  // Per-task breakdown
  const tasks = Array.isArray(s.tasks) ? s.tasks : [];
  const sec = document.createElement('div');
  sec.className = 'section';
  sec.innerHTML = '<div class="section-title">Task breakdown</div>';

  tasks.forEach((t, i) => {
    const card = document.createElement('div');
    card.className = 'task-detail-card';

    const completedBadge = t.completed
      ? '<span class="badge badge-green">âœ“ Completed</span>'
      : (t.skipped ? '<span class="badge badge-amber">âŠ˜ Skipped</span>' : '<span class="badge badge-red">âœ— Not completed</span>');

    card.innerHTML = `
      <div class="task-detail-head">
        <div>
          <strong>${i + 1}. ${t.taskTitle}</strong>
          <span style="font-size:11px;color:var(--muted);margin-left:8px">${t.taskType === 'recall' ? 'Recall' : 'Goal'}</span>
        </div>
        ${completedBadge}
      </div>
      <div class="task-detail-body">
        <div class="task-detail-row">
          <span class="task-detail-meta">Duration: <strong>${t.durationFmt || 'â€”'}</strong></span>
          <span class="task-detail-meta">Ease: <strong>${t.easeRating ? t.easeRating + '/5' : 'â€”'}</strong></span>
          ${t.taskType === 'recall' ? `<span class="task-detail-meta">Recall answer: <strong>${t.recallAnswer || 'â€”'}</strong></span>` : ''}
          ${t.taskType === 'recall' && t.recallCorrect != null ? `<span class="task-detail-meta">Correct: <strong>${t.recallCorrect ? 'âœ“ Yes' : 'âœ— No'}</strong></span>` : ''}
        </div>
        ${t.comment ? `<div class="comment-box">"${t.comment}"</div>` : ''}
        ${t.clicks && t.clicks.length ? `
          <details class="click-list">
            <summary>${t.clicks.length} click${t.clicks.length !== 1 ? 's' : ''} recorded</summary>
            <div class="click-chips">
              ${t.clicks.map(c => `<span class="click-chip">${c.tag}${c.id ? '#' + c.id : ''} "${(c.txt || '').slice(0,20)}"</span>`).join('')}
            </div>
          </details>
        ` : ''}
      </div>
    `;
    sec.appendChild(card);
  });

  main.appendChild(sec);
}
</script>
</body>
</html>
